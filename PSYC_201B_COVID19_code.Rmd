---
title: "PSYC_201B_COVID_codes"
author: Hyojeong(Jenny) Yoo, Jinah Kim, Juanshu(Sky) Wu, Muqing Fan, Xiangyu(Alaric) Wei, Yuchen(Eva) Liu  
date: "2/28/2021"
output: 
  html_document:
    toc: true
    theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, message=FALSE)
```

# Introduction
In this file, we cleaned and explored our following datasets:   
- **JHU covid data (curren)**: https://github.com/CSSEGISandData/COVID-19  
- **Google mobility reports (current)**: https://www.google.com/covid19/mobility/?hl=en  
The JHU COVID-19 date provided us with historical covid progressions. Mobility data provided us relevant information during the pandemic. All datasets are analyzed on state-level.

# Data Cleaning 
Importing packages
```{r, message=FALSE}
library(tidyverse)
library(dplyr)
library(zoo)
library(imputeTS)
```

## SVI data for county population 
selecting relevant indices (refer to codebook)
```{r, message=FALSE}
# svi.raw <- read_csv("./datasets/SVI2018_US_COUNTY.csv")
# svi.data <- svi.raw %>%
#   select(STATE,
#          COUNTY,
#          FIPS,
#          E_TOTPOP) %>%
#   mutate(FIPS = as.numeric(FIPS),
#          county = paste(COUNTY, "County"))

```


## JHU COVID-19 data cleaning

loading JHU covid confirmed historical dateset
```{r, message=FALSE}
# covid.confirmed.raw <- data.table::fread("./datasets/csse_covid_19_time_series/time_series_covid19_confirmed_US.csv")
# glimpse(covid.confirmed.raw)
# cumulative confirmed cases on county level 
```

cleaning JHU covid confirmed historical dateset
```{r, message=FALSE}
# covid.confirmed <- covid.confirmed.raw %>%
#   select(-c(UID, iso2, iso3, code3, FIPS, Country_Region, Lat, Long_, Combined_Key)) %>%
#   rename(state = Province_State,
#          county = Admin2) %>%
#   group_by(county) %>% # Specify group indicator
#   # summarise(across(everything(), sum)) %>% # Specify column
#   pivot_longer(-c(state, county),
#                names_to = "date",
#                values_to = "cumulative.confirmed.cases") %>%
#   filter(state %in% c(state.name, "District of Columbia")) %>%
#   group_by(county) %>%
#   mutate(confirmed.cases = cumulative.confirmed.cases - lag(cumulative.confirmed.cases),
#          date = as.Date(date, format = "%m/%d/%y"),
#          confirmed.cases = replace_na(confirmed.cases, 0),
#          county = paste(county, "County"))
# 
# # fix negative cumulative cases
# while (any(covid.confirmed$confirmed.cases < 0)) {
#   covid.confirmed <- covid.confirmed %>%
#     mutate(cumulative.confirmed.cases = ifelse(cumulative.confirmed.cases < lag(cumulative.confirmed.cases),
#                                          lag(cumulative.confirmed.cases), # if smaller than previous
#                                          cumulative.confirmed.cases), # if not
#            cumulative.confirmed.cases = replace_na(cumulative.confirmed.cases, 0),
#            confirmed.cases = cumulative.confirmed.cases - lag(cumulative.confirmed.cases),
#            confirmed.cases = replace_na(confirmed.cases, 0))
# }

```

Just plotting something out~
```{r}
# covid.confirmed[1:5000,] %>%
#   ggplot(aes(x = date, y = cumulative.confirmed.cases, color = county)) +
#   geom_line() +
#   scale_color_hue(name='Midwest States')+
#   scale_x_date(date_breaks = "1 month", date_labels = "%b") +
#   # ylim(0, 1000000)+
#   ylab("Cumulative Confirmed Cases") +
#   xlab("Date") +
#   ggtitle("Cumulative Confirmed Cases in Midwest US") +
#   theme_minimal() +
#   theme(axis.title = element_text(size=12), # change axis style
#         legend.title = element_text(size=12), # change legend style
#         plot.title = element_text(size=14)) # change title style
```


## Cleaning Google mobility data

Importing Google mobility dataset
```{r}
# US_Region_2020_mobility <- read.csv( "./datasets/2020_US_Region_Mobility_Report.csv", header=T, na.strings=c("","NA"))
```

Cleaning mobility dataset
```{r, message=FALSE}
# US_State_2020_mobility <- US_Region_2020_mobility %>% filter(sub_region_2 != "Null") %>% rename(county = sub_region_2)
# 
# # unique(US_State_2020_mobility_without_county$sub_region_1)
# StateMonthMobility <- US_State_2020_mobility %>%
#   mutate(date = as.Date(date, "%Y-%m-%d"))
```

## combining covid and mobility dataset
```{r}
# length(unique(covid.confirmed$county)) # 1901
# length(unique(StateMonthMobility$census_fips_code)) # 2837
# length(unique(StateMonthMobility$county)) # 1718
```


```{r}
# covid.time.series <- covid.confirmed %>%
#   inner_join(StateMonthMobility, by = c("county","date")) %>%
#   select(county, state, date, cumulative.confirmed.cases, confirmed.cases,
#          retail_and_recreation_percent_change_from_baseline,
#          grocery_and_pharmacy_percent_change_from_baseline,
#          parks_percent_change_from_baseline,
#          transit_stations_percent_change_from_baseline,
#          workplaces_percent_change_from_baseline)
# 
# covid.time.series <- covid.time.series %>%
#   inner_join(svi.data, by = "county") %>%
#   select(-c(STATE, COUNTY, FIPS)) %>%
#   rename(population = E_TOTPOP)
# 
# 
# dim(covid.time.series) # 58818935, 11
# length(unique(covid.time.series$county)) # 1600
# saveRDS(covid.time.series, file = "datasets/covid time series version 1.Rds")
```

## growth rate 
```{r}
covid.time.series <- readRDS('datasets/covid time series version 1.Rds')
# dim(covid.time.series) # 58818935, 11
# 
# # active rates df
# covid.time.series <- covid.time.series %>%
#   mutate(confirmed.rates = 100 * confirmed.cases / population) %>%
#   select(c(county, date, retail_and_recreation_percent_change_from_baseline, grocery_and_pharmacy_percent_change_from_baseline, parks_percent_change_from_baseline, transit_stations_percent_change_from_baseline, workplaces_percent_change_from_baseline, confirmed.rates)) %>%
#   filter(date >= as.Date("2020-04-13") & date <= as.Date("2021-01-31"))
# 
# dim(covid.time.series) # 46234618, 8
# 
# covid.time.series <- covid.time.series %>%
#   group_by(county) %>%
#   mutate(avg.3days = (rollsumr(confirmed.rates, k = 3, fill = NA))/3,
#          avg.7days = (rollsumr(confirmed.rates, k = 7, fill = NA))/7)
# 
# dates.gr <- format(seq(from = as.Date("2020/04/20"), to = as.Date("2021/02/16"), by = "day"), "%Y-%m-%d")
# 
# for (date in dates.gr){
#   covid.time.series <- covid.time.series %>%
#     group_by(county) %>%
#     mutate(growth.rate = log(avg.3days)/log(avg.7days))
# }
# 
# saveRDS(covid.time.series, file = "datasets/covid time series version 2.Rds")
# glimpse(covid.time.series)
```

## biweekly binning 
```{r}
# covid.time.series <- readRDS("datasets/covid time series version 2.Rds")
# # dim(covid.time.series) # 46234618, 11
# 
# covid.time.series <- covid.time.series %>%
#   mutate(month = months(date),
#          week = format(date, format = '%W'),
#          # the following code converts to biweekly
#          biweek = 14 * (as.numeric(date - min(date)) %/% 14) + min(date)) %>%
#   group_by(county, biweek) %>%
#   summarise(confirmed.avg = mean(confirmed.rates, na.rm=TRUE),
#             retail.recreation.avg = mean(retail_and_recreation_percent_change_from_baseline, na.rm=TRUE),
#             grocery.pharmacy.avg = mean(grocery_and_pharmacy_percent_change_from_baseline, na.rm=TRUE),
#             parks.avg = mean(parks_percent_change_from_baseline, na.rm=TRUE),
#             transit.avg = mean(transit_stations_percent_change_from_baseline, na.rm=TRUE),
#             workplace.avg = mean(workplaces_percent_change_from_baseline, na.rm=TRUE))
# 
# dim(covid.time.series)
# saveRDS(covid.time.series, file = "datasets/covid time series version 3.Rds")
```



# Data analysis

## PCA 
```{r}
# start running here~~~~~!!!!
covid.time.series <- readRDS("datasets/covid time series version 3.Rds")
# dim(covid.time.series) # 32242, 8
# count NaN ratio?

covid.time.series.1 <- covid.time.series %>% na.omit
covid.time.series.2 <- covid.time.series %>%
  select(-parks.avg)
covid.time.series.3 <- covid.time.series.2 %>% na.omit
l1 = unique(covid.time.series$county)
l3 = unique(covid.time.series.3$county)
# check fluctuations in data
ggplot(covid.time.series, aes(x = biweek, y = confirmed.avg)) + 
  geom_line() 

covid.time.series.nas <- covid.time.series.2 %>%
  group_by(county) %>%
  summarise_each(funs(sum(is.na(.)))) %>%
  filter(retail.recreation.avg <= 2 & grocery.pharmacy.avg <= 2 & transit.avg <= 2 & workplace.avg <= 2)

county_nonnas = c(covid.time.series.nas$county)

covid.time.series.nonnas <- covid.time.series.2 %>% 
  filter(county %in% county_nonnas) %>%
  group_by(county) %>%
#  filter(rowSums(covid.time.series.nonnas, ) > 2)
# Barber County has only 2 data points 
  filter(county != "Barber County") %>%
  filter(county != "Furnas County") %>%
  filter(county != "Hartley County") %>%
  filter(county != "Ouray County") %>%
  filter(county != "Wirt County")

sapply(covid.time.series.nonnas, function(x) sum(is.na(x)))
# data3 <- data[rowSums(is.na(data)) == 0, ]
# covid.time.series.nas <- covid.time.series.nonnas[, colSums(is.na(covid.time.series.nonnas)) <= 2]

```
### PCA imputation 
```{r}
covid.time.series.imputed <- covid.time.series.nonnas %>%
  group_by(county) %>%
  # a lot of fluctuations so simple avg
  mutate(retail.recreation.avg = na_ma(retail.recreation.avg, weighting = "simple"),
         grocery.pharmacy.avg = na_ma(grocery.pharmacy.avg, weighting = "simple"),
         transit.avg = na_ma(transit.avg, weighting = "simple"),
         workplace.avg = na_ma(workplace.avg, weighting = "simple"))

library(robustHD)
covid.time.series.imputed[,3:7] = standardize(covid.time.series.imputed[,3:7])

# why filter?
#mobility.active.rates <- mobility.active.rates %>% 
#  filter(date >= as.Date("2020-04-19")) 

glimpse(covid.time.series.imputed)
```

### PCA calculation 
PCA calculation
```{r}
library(missMDA)
# filling missing data using iterative imputation
#nb <- estim_ncpPCA(mobility.active.rates[,3:7], method.cv = "Kfold", verbose = FALSE) # estimate the number of components from incomplete data 

#(available methods include GCV to approximate CV)
#nb$ncp #4

# mobility.active.comp <- imputePCA(mobility.active.rates[,3:7], ncp = nb$ncp) # iterativePCA algorithm

covid.mobility.pca <- prcomp(covid.time.series.imputed[,3:7], center = TRUE, scale = TRUE)
#mobility.pca$x[,"PC1"]
covid.mobility.pca$rotation <- covid.mobility.pca$rotation
covid.mobility.pca$x <- covid.mobility.pca$x # negation necessary?
#biplot(mobility.pca, scale = 0)

# combine imputed data with growth rate 
#mobility.active.rates.imputed <- data.frame(mobility.active.comp$completeObs) %>% 
#  cbind(mobility.active.rates[,c(1,2)], ., mobility.active.rates[,c(9,10,11,12)])
# add PC1 as pca
covid.time.series.imputed$covid.mobility.pca = covid.mobility.pca$x[,"PC1"]

glimpse(covid.time.series.imputed)
```



## residual to residual analysis 
```{r}
# add states to the lm() model?
mobility.active.country.lm <- lm(growth.rate.avg ~ mobility.pca.avg, data = covid.time.series.imputed)
mobility.active.country.res <- residuals(mobility.active.country.lm)
# retail and recreation
retail.active.country.lm <- lm(retail.recreation.avg ~ mobility.pca.avg, data = covid.time.series.imputed)
retail.bottom.res <- residuals(retail.active.country.lm)
# below is lm(residual ~ residual)
retail.country.lm <- lm(mobility.active.country.res ~ retail.bottom.res)
retail.country.sum <- summary(retail.country.lm)
# r squared = 0.1026


# grocery and pharmacy
grocery.pharmacy.mobility.country.lm <- lm(grocery.pharmacy.avg ~ mobility.pca.avg, data = covid.time.series.imputed)
grocery.pharmacy.mobility.country.res <- residuals(grocery.pharmacy.mobility.country.lm)
# below is lm(residual ~ residual)
grocery.country.lm <- lm(mobility.active.country.res ~ grocery.pharmacy.mobility.country.res)
grocery.country.sum <- summary(grocery.country.lm)
# r squared =   0.01809

# parks
parks.mobility.country.lm <- lm(parks.avg ~ mobility.pca.avg, data = covid.time.series.imputed)
# below is lm(residual ~ residual)
parks.mobility.country.res <- residuals(parks.mobility.country.lm)
parks.country.lm <- lm(mobility.active.country.res ~ parks.mobility.country.res)
parks.country.sum <- summary(parks.country.lm)
# r squared = 0.07035

# transit
transit.mobility.country.lm <- lm(transit.avg ~ mobility.pca.avg, data = covid.time.series.imputed)
# below is lm(residual ~ residual)
transit.mobility.country.res <- residuals(transit.mobility.country.lm)
transit.country.lm <- lm(mobility.active.country.res ~ transit.mobility.country.res)
transit.country.sum <- summary(transit.country.lm)
# r squared = 0.0005598

# workplace
workplace.mobility.country.lm <- lm(workplace.avg ~ mobility.pca.avg, data = covid.time.series.imputed)
workplace.mobility.country.res <- residuals(workplace.mobility.country.lm)
# below is lm(residual ~ residual)
workplace.country.lm <- lm(mobility.active.country.res ~ workplace.mobility.country.res)
workplace.country.sum <- summary(workplace.country.lm)
# r squared =  0.0495
```











